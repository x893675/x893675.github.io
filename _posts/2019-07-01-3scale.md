---
layout:     post
title:      "API 网关"
subtitle:   " \"3scale调研\""
date:       2019-07-01 12:00:00
author:     "Hanamichi"
header-img: "img/spacex-1.jpg"
catalog: true
tags:
    - openshift
    - k8s
---

## 3scale功能调研

### 环境说明

* openshift 3.11
* amp 2.5

### 部署步骤

* `cd /etc/rhsm/ca && touch redhat-uep.pem`(确认openshift集群的机器能从**registry.access.redhat.com**拉取镜像)
* `oc new-project 3scale-amp --display-name="3scale AMP 2.5" --description="3scale AMP 2.5"`
* 使用[AMP部署模版](amp.yaml)部署amp
  * 修改模版中**ADMIN_PASSWORD**,**MASTER_PASSWORD**参数的值
  * 修改模版中**WILDCARD_DOMAIN**的值，注意此值为openshift集群router的子域。例如测试环境搭在`demo2-aio-master.demotheworld.com`中，所以此参数的值为`demo2-aio-apps.demotheworld.com`
  * 修改模版中**WILDCARD_POLICY**的值为`Subdomain`
  * 修改模版中**STORAGE_CLASS**的值为部署集群中的storage class的相应名称
  * 修改模版中**RWX_STORAGE_CLASS**的值为支持**RWX**模式的storage class的名称
  * 从修改后的模版创建应用
* 部署成功后会在`3scale-amp`项目下看到以下路由
  * ![3scale-router-default](/img/post-3scale/3scale-router-default.png)
  * 从`system-provider-admin`路由可以登录到默认租户`3scale`的管理界面，进行api的管理
  * 从`system-master`路由可以登录到多租户管理界面，在该页面添加租户。
  * `api-apicast-staging`和`api-apicast-production`是租户`3scale`中的缺省api所用的apicast的两条路由，当用户第一次登陆`system-provider-admin`时，会由系统引导创建一个默认api应用。

### 3scale功能

* 创建api应用与后端api进行映射，并对每个api设置策略进行管理
* 每个api应用可以设置多个**Application Plans**，通过application plan设置不同的 API 管理策略，包括访问权限、登录步骤、可接入的端点及资源、及记费模型等
* 创建多个api用户与api应用进行关联，每个用户可以设置不同的application plan，并且拥有不同的认证凭证。
* 创建多个租户

参考链接:
* [3scale api management](https://access.redhat.com/documentation/en-us/red_hat_3scale_api_management/2.5/html-single/admin_portal_guide/)
* [3scale git book](http://ksoong.org/agile-integration/content/3scale/readme.html)

### 使用注意事项

* 同一个租户下的多个api应用，需要手动创建该api应用的apicast路由，hostname的规则为`apiname-TENANT_NAME-apicast-staging-WILDCARD_DOMAIN`，如下图所示
  * ![](/img/post-3scale/3scale-route2.png)
  * 图中`finto-api`是api应用的名字，`3scale`为租户名，`apicast-staging`为固定字段，`demo2-aio-apps.demotheworld.com`为创建amp应用时指定的`WILDCARD_DOMAIN`参数
* 在master门户中创建新的租户时，也需要手动创建该新建租户使用的amp路由和apicast路由,hostname的基本规则同上
  * ![](/img/post-3scale/3scale-route3.png)
  * 图中所示的租户名为test, 需要创建一个test-admin的路由到amp服务，两种环境的apicast路由。

### 服务发现

3scale可以直接从openshift的service创建新的api应用

#### openshift配置:

* `oc project 3scale-amp && oc edit cm system`,确认configmap中有如下配置:
  * ![](/img/post-3scale/3scale-service-discovery.png)
* `oc adm policy add-cluster-role-to-user view system:serviceaccount:3scale-amp:default`

#### 服务配置

* 在openshfit中部署的应用，若要导入3scale，需要在service配置的metadata中添加几条注解:
  * ![](/img/post-3scale/3scale-svc-metadata.png)
* 下图是测试时部署的用户管理程序的svc
  * ![](/img/post-3scale/3scale-user-svc.png)
* 设置好后就可以在3scale的admin面板中导入api
  * ![](/img/post-3scale/3scale-admin-new-api.png)
* 这个功能目前只是创建一个api应用，并将服务的地址和访问端口记录，api的映射关系和账单等需要自己配置。可以从下图看到，配置为服务发现导入的api，访问基地址是通过服务名访问
  * ![](/img/post-3scale/3scale-user-apicast.png)


